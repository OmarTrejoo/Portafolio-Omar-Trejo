---
import type { ExperienceItem } from '../types';
import BackgroundEffects from "./ui/BackgroundEffects.astro";
import SectionBackground from "./ui/SectionBackground.astro";
import SectionTitle from "./ui/SectionTitle.astro";
import Badge from "./ui/Badge.astro";
import Icon from "./ui/Icon.astro";
import { techIcons } from "../data/techIcons";

interface Props {
  experience: ExperienceItem[];
  lang: 'es' | 'en';
}

const { experience, lang } = Astro.props;

const labels = {
  title: lang === 'es' ? 'Experiencia' : 'Experience',
  techStack: lang === 'es' ? 'Stack Tecnológico' : 'Tech Stack',
  viewGallery: lang === 'es' ? 'Ver Galería' : 'View Gallery',
  photos: lang === 'es' ? 'fotos' : 'photos',
  closeGallery: lang === 'es' ? 'Cerrar galería' : 'Close gallery',
  prevImage: lang === 'es' ? 'Imagen anterior' : 'Previous image',
  nextImage: lang === 'es' ? 'Imagen siguiente' : 'Next image',
  current: lang === 'es' ? 'Actual' : 'Current',
  total: lang === 'es' ? 'Total' : 'Total'
};
---

<section
	id="experiencia"
	class="bg-slate-950 text-slate-100 border-t border-slate-800/50 relative overflow-hidden"
>
	<BackgroundEffects />
	<SectionBackground variant="dark" gradientPosition="center" />

	<div class="container mx-auto px-4 sm:px-6 lg:px-8 py-16 md:py-20 relative z-10">
		<div class="max-w-6xl mx-auto">

			<SectionTitle title={labels.title} align="center" />


			<div class="relative">
				<div class="hidden md:block absolute left-1/2 top-0 bottom-0 w-0.5 bg-gradient-to-b from-emerald-500/20 via-emerald-500/50 to-emerald-500/20 -translate-x-1/2 shadow-[0_0_10px_rgba(16,185,129,0.3)]"></div>

				<div class="space-y-12 md:space-y-16">
					{
						experience.map((item, index) => {
							const isEven = index % 2 === 0;
							
							return (
								<div 
									class="relative animate-on-scroll" 
									data-animate
								>
									<div class="hidden md:block absolute left-1/2 top-16 -translate-x-1/2 z-20">
										{isEven ? (
											<div class="absolute top-1/2 right-0 w-20 h-px bg-gradient-to-r from-emerald-500/50 to-emerald-500/20"></div>
										) : (
											<div class="absolute top-1/2 left-0 w-20 h-px bg-gradient-to-l from-emerald-500/50 to-emerald-500/20"></div>
										)}
										
										<div class={`absolute top-1/2 -translate-y-1/2 ${isEven ? 'right-20' : 'left-20'}`}>
											<div class="bg-slate-950 px-4 py-2 border border-slate-700/30 rounded-lg shadow-lg shadow-white/5">
												<div class="flex items-center gap-2">
													<Icon name="calendar" class="text-slate-400" />
													<span class="text-slate-300 font-bold text-sm whitespace-nowrap">{item.period}</span>
												</div>
											</div>
										</div>
									</div>

									<div class={`md:grid md:grid-cols-2 md:gap-8 ${isEven ? '' : 'md:grid-flow-dense'}`}>

										<div class={`hidden md:block ${isEven ? 'md:order-1' : 'md:order-2'}`}></div>
										
										<div class={`${isEven ? 'md:order-2' : 'md:order-1'} relative`}>
											{isEven ? (
												<div class="hidden md:block absolute left-0 top-1/2 -translate-y-1/2 -translate-x-full w-4 h-px bg-gradient-to-l from-emerald-500/50 to-emerald-500/20 z-0"></div>
											) : (
												<div class="hidden md:block absolute right-0 top-1/2 -translate-y-1/2 translate-x-full w-4 h-px bg-gradient-to-r from-emerald-500/50 to-emerald-500/20 z-0"></div>
											)}
											
											<div class="group relative bg-slate-950 border border-slate-800/50 rounded-2xl overflow-hidden shadow-lg shadow-white/5 hover:scale-[1.02] hover:shadow-xl hover:shadow-emerald-500/10 transition-all duration-300 z-10">

												{isEven ? (
													<div class="absolute top-0 right-0 w-1.5 h-full bg-gradient-to-b from-emerald-400/80 via-teal-400/60 to-emerald-500/40 rounded-tr-2xl rounded-br-2xl"></div>
												) : (
													<div class="absolute top-0 left-0 w-1.5 h-full bg-gradient-to-b from-emerald-400/80 via-teal-400/60 to-emerald-500/40 rounded-tl-2xl rounded-bl-2xl"></div>
												)}
												
												<div class="p-6 md:p-8">

													<div class="flex items-start justify-between gap-4 mb-4">
														<div class="flex-1 min-w-0">
											<h3 class="text-xl md:text-2xl font-bold text-white mb-2 group-hover:text-emerald-50 transition-colors">
												{item.title}
											</h3>
											<div class="flex items-center gap-2 text-slate-400 mb-2">
												<Icon name="building" class="text-emerald-400 flex-shrink-0" />
												<span class="font-medium">{item.company}</span>
											</div>
															{(item.location || item.workMode) && (
																<div class="flex items-center gap-3 text-slate-500 text-sm mb-3">
																	{item.location && (
																		<div class="flex items-center gap-1.5">
																			<Icon name="location" size="sm" />
																			<span>{item.location}</span>
																		</div>
																	)}
																	{item.workMode && (
																		<div class="flex items-center gap-1.5">
																			<span class="text-slate-600">•</span>
																			<span>{item.workMode}</span>
																		</div>
																	)}
																</div>
															)}
														</div>
													</div>


										<div class="md:hidden mb-4">
											<div class="inline-flex items-center gap-2 px-3 py-1.5 bg-white/5 border border-slate-700/30 rounded-lg text-slate-300 text-sm font-medium">
												{item.period}
											</div>
										</div>													{/* Description */}
													<p class="text-slate-300 leading-relaxed mb-6 text-sm md:text-base">
														{item.description}
													</p>


													<div class="space-y-3">
														<p class="text-xs font-semibold text-slate-400 uppercase tracking-wider">{labels.techStack}</p>
														<div class="flex flex-wrap gap-2">
															{item.technologies.map((tech) => (
                                <Badge label={tech} icon={techIcons[tech]} />
															))}
														</div>
													</div>


													{item.gallery && item.gallery.length > 0 && (
														<div class="pt-4 mt-4 border-t border-slate-800/50">
															<button
																data-gallery-open={index}
																aria-label={`${labels.viewGallery} - ${item.title}`}
																class="group/btn w-full flex items-center justify-center gap-2 px-4 py-3 bg-slate-800/30 border border-slate-700/50 rounded-lg hover:border-emerald-500/40 hover:bg-slate-800/50 transition-all duration-300 hover:scale-105"
															>
																<Icon name="gallery" size="lg" class="text-emerald-400" />
																<span class="text-sm font-semibold text-slate-300 group-hover/btn:text-white transition-colors">
																	{labels.viewGallery}
																</span>
																<span class="text-xs text-slate-500 group-hover/btn:text-emerald-400 transition-colors">
																	({item.gallery.length} {labels.photos})
																</span>
															</button>
														</div>
													)}
												</div>

										{/* Indicador lateral para mostrar lado */}
										<div class={`hidden md:block h-1 ${isEven ? 'bg-gradient-to-r from-emerald-500/50 to-transparent' : 'bg-gradient-to-l from-emerald-500/50 to-transparent'}`} aria-hidden="true"></div>
									</div>
								</div>
							</div>


							<div class="md:hidden mt-8 mb-4 flex items-center gap-4" aria-hidden="true">
								<div class="h-px flex-1 bg-slate-800/50"></div>
								<div class="w-2 h-2 rounded-full bg-emerald-500/50 animate-pulse"></div>
								<div class="h-px flex-1 bg-slate-800/50"></div>
									</div>
								</div>
							);
						})
					}
				</div>
			</div>


		</div>
	</div>


	<div 
		id="gallery-modal" 
		class="fixed inset-0 z-50 hidden items-center justify-center bg-black/90 backdrop-blur-sm"
		style="display: none;"
	>

		<div id="gallery-content" class="relative w-full h-full flex items-center justify-center p-4 md:p-8 opacity-0 scale-95 transition-all duration-300">

		<button
			id="gallery-close"
			class="absolute top-4 right-4 z-10 w-12 h-12 flex items-center justify-center bg-slate-900/80 backdrop-blur-sm border border-slate-700/50 rounded-full hover:bg-slate-800 hover:border-emerald-500/50 transition-all group"
			aria-label={labels.closeGallery}
		>
			<Icon name="close" class="text-slate-400 group-hover:text-white transition-colors" size="xl" />
		</button>
			<div class="hidden md:block absolute top-4 left-4 z-10">
				<div class="bg-slate-900/80 backdrop-blur-sm border border-slate-700/50 rounded-lg px-4 py-2">
					<h3 id="gallery-title" class="text-sm md:text-base font-semibold text-white"></h3>
				</div>
			</div>


			<div class="relative w-full max-w-6xl">
				{/* Previous Button */}
			<button
				id="gallery-prev"
				class="absolute left-0 md:-left-16 top-1/2 -translate-y-1/2 z-10 w-12 h-12 flex items-center justify-center bg-slate-900/80 backdrop-blur-sm border border-slate-700/50 rounded-full hover:bg-slate-800 hover:border-emerald-500/50 transition-all group"
				aria-label={labels.prevImage}
			>
				<Icon name="arrow-left" class="text-slate-400 group-hover:text-white transition-colors" size="xl" />
			</button>
				<div class="bg-slate-900/50 backdrop-blur-sm border border-slate-800/50 rounded-2xl overflow-hidden">
					<img
						id="gallery-image"
						src=""
						alt="Screenshot"
						class="w-full h-auto max-h-[70vh] object-contain"
					/>
				</div>


			<button
				id="gallery-next"
				class="absolute right-0 md:-right-16 top-1/2 -translate-y-1/2 z-10 w-12 h-12 flex items-center justify-center bg-slate-900/80 backdrop-blur-sm border border-slate-700/50 rounded-full hover:bg-slate-800 hover:border-emerald-500/50 transition-all group"
				aria-label={labels.nextImage}
			>
				<Icon name="arrow-right" class="text-slate-400 group-hover:text-white transition-colors" size="xl" />
			</button>
				<div class="absolute bottom-4 left-1/2 -translate-x-1/2">
					<div class="bg-slate-900/80 backdrop-blur-sm border border-slate-700/50 rounded-lg px-4 py-2">
						<p class="text-sm font-medium text-white">
							<span id="gallery-current">1</span> / <span id="gallery-total">1</span>
						</p>
					</div>
				</div>
			</div>


			<div class="absolute bottom-8 left-1/2 -translate-x-1/2 flex gap-2" id="gallery-indicators">
				{/* Will be populated by JS */}
			</div>
		</div>
	</div>
</section>

<style>
	/* Scroll animation - usa fade-in-up de global.css */
	.animate-on-scroll {
		opacity: 0;
	}

	.animate-on-scroll.visible {
		animation: fade-in-up 0.8s ease-out forwards;
	}
</style>

<script define:vars={{ experienceGalleryData: experience.map(item => ({ title: item.title, company: item.company, gallery: item.gallery || null })) }}>
	let currentGalleryIndex = 0;
	let currentImageIndex = 0;
	let currentGallery = [];

	const modal = document.getElementById('gallery-modal');
	const modalImage = document.getElementById('gallery-image');
	const modalTitle = document.getElementById('gallery-title');
	const modalCurrent = document.getElementById('gallery-current');
	const modalTotal = document.getElementById('gallery-total');
	const closeBtn = document.getElementById('gallery-close');
	const prevBtn = document.getElementById('gallery-prev');
	const nextBtn = document.getElementById('gallery-next');

	function openGallery(experienceIndex) {
		const exp = experienceGalleryData[experienceIndex];
		if (!exp || !exp.gallery || exp.gallery.length === 0) return;

		currentGalleryIndex = experienceIndex;
		currentGallery = exp.gallery;
		currentImageIndex = 0;

		modalTitle.textContent = `${exp.title} - ${exp.company}`;
		modalTotal.textContent = currentGallery.length;

		showImage(0);
		modal.style.display = 'flex';
		void modal.offsetWidth;
		modal.classList.remove('hidden');
		
		const content = document.getElementById('gallery-content');
		requestAnimationFrame(() => {
			content.classList.remove('opacity-0', 'scale-95');
			content.classList.add('opacity-100', 'scale-100');
		});

		document.body.style.overflow = 'hidden';
	}

	function closeGallery() {
		const content = document.getElementById('gallery-content');
		content.classList.remove('opacity-100', 'scale-100');
		content.classList.add('opacity-0', 'scale-95');

		setTimeout(() => {
			modal.style.display = 'none';
			modal.classList.add('hidden');
			document.body.style.overflow = '';
		}, 300);
	}

	function showImage(index) {
		if (index < 0) index = currentGallery.length - 1;
		if (index >= currentGallery.length) index = 0;

		currentImageIndex = index;
		modalImage.src = currentGallery[index];
		modalCurrent.textContent = index + 1;
	}

	function prevImage() {
		showImage(currentImageIndex - 1);
	}

	function nextImage() {
		showImage(currentImageIndex + 1);
	}

	function initGallery() {
		document.querySelectorAll('[data-gallery-open]').forEach(btn => {
			btn.addEventListener('click', () => {
				const index = parseInt(btn.getAttribute('data-gallery-open'));
				openGallery(index);
			});
		});

		if (closeBtn) {
			closeBtn.addEventListener('click', closeGallery);
		}
		if (prevBtn) {
			prevBtn.addEventListener('click', prevImage);
		}

		if (nextBtn) {
			nextBtn.addEventListener('click', nextImage);
		}

		if (modal) {
			modal.addEventListener('click', (e) => {
				if (e.target === modal) {
					closeGallery();
				}
			});
		}

		document.addEventListener('keydown', (e) => {
			if (modal && modal.style.display === 'flex') {
				if (e.key === 'Escape') {
					closeGallery();
				} else if (e.key === 'ArrowLeft') {
					prevImage();
				} else if (e.key === 'ArrowRight') {
					nextImage();
				}
			}
		});
	}

	function initScrollAnimations() {
		const observer = new IntersectionObserver(
			(entries) => {
				entries.forEach((entry) => {
					if (entry.isIntersecting) {
						entry.target.classList.add('visible');
					}
				});
			},
			{
				threshold: 0.1,
				rootMargin: '0px 0px -50px 0px'
			}
		);

		document.querySelectorAll('[data-animate]').forEach((el) => {
			observer.observe(el);
		});
	}

	document.addEventListener('DOMContentLoaded', () => {
		initGallery();
		initScrollAnimations();
	});
	document.addEventListener('astro:page-load', () => {
		initGallery();
		initScrollAnimations();
	});
</script>
